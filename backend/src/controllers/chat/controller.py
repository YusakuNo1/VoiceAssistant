import uuid
from typing import Annotated
from fastapi import Header
from fastapi.responses import StreamingResponse

from src.config.app import app
from src.utils.loggers import log
from .types import Request
from .service import chat, chat_history, chat_llamacpp


# Sample query for string only:
#   curl -X POST http://127.0.0.1/chat --header "Content-Type: application/json" --header "chat-id: my-id-123" --data '{ "messages": [{ "role": "user", "content": "where is the headquarter of microsoft" }] }'
# Sample query for string in array:
#   curl -X POST http://127.0.0.1/chat --header "Content-Type: application/json" --header "chat-id: my-id-123" --data '{ "messages": [{ "role": "user", "content": [{ "type": "text", "text": "where is the headquarter of microsoft" }] }] }'
# Sample query for image:
#   curl -X POST http://127.0.0.1/chat --header "Content-Type: application/json" --header "chat-id: my-id-123" --data '{ "messages": [{ "role": "user", "content": [{ "type": "text", "text": "what is in the image?" }, { "type": "image_url", "image_url": { "url": "data:image/png;base64,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CiAgICB4bWxuczpkYz0iaHR0cDovL3B1cmwub3JnL2RjL2VsZW1lbnRzLzEuMS8iCiAgICB4bWxuczpHSU1QPSJodHRwOi8vd3d3LmdpbXAub3JnL3htcC8iCiAgICB4bWxuczp0aWZmPSJodHRwOi8vbnMuYWRvYmUuY29tL3RpZmYvMS4wLyIKICAgIHhtbG5zOnhtcD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLyIKICAgeG1wTU06RG9jdW1lbnRJRD0iZ2ltcDpkb2NpZDpnaW1wOjhiNjA0NWZlLWVkMTEtNDBiYS1iZWMzLWYzZmNkYTY2YmFiMCIKICAgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDo0NmUwMDE0Yy1kYzA1LTRjMTgtYmFiNC0yNmRkNDU3OTc1MTAiCiAgIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDpiZDZlNDg5MC0xODBlLTQ2YTctODcyNS1mN2VlZjg1ZDRjNTgiCiAgIGRjOkZvcm1hdD0iaW1hZ2UvcG5nIgogICBHSU1QOkFQST0iMi4wIgogICBHSU1QOlBsYXRmb3JtPSJNYWMgT1MiCiAgIEdJTVA6VGltZVN0YW1wPSIxNzM1MjQxNzg3OTM1MDYwIgogICBHSU1QOlZlcnNpb249IjIuMTAuMzIiCiAgIHRpZmY6T3JpZW50YXRpb249IjEiCiAgIHhtcDpDcmVhdG9yVG9vbD0iR0lNUCAyLjEwIgogICB4bXA6TWV0YWRhdGFEYXRlPSIyMDI0OjEyOjI2VDExOjM2OjIzLTA4OjAwIgogICB4bXA6TW9kaWZ5RGF0ZT0iMjAyNDoxMjoyNlQxMTozNjoyMy0wODowMCI+CiAgIDx4bXBNTTpIaXN0b3J5PgogICAgPHJkZjpTZXE+CiAgICAgPHJkZjpsaQogICAgICBzdEV2dDphY3Rpb249InNhdmVkIgogICAgICBzdEV2dDpjaGFuZ2VkPSIvIgogICAgICBzdEV2dDppbnN0YW5jZUlEPSJ4bXAuaWlkOjdhZjkyNjVhLTNmNWEtNDdlNy1hOWRlLTZhZDhkMmRiYTc0NSIKICAgICAgc3RFdnQ6c29mdHdhcmVBZ2VudD0iR2ltcCAyLjEwIChNYWMgT1MpIgogICAgICBzdEV2dDp3aGVuPSIyMDI0LTEyLTI2VDExOjM2OjI3LTA4OjAwIi8+CiAgICA8L3JkZjpTZXE+CiAgIDwveG1wTU06SGlzdG9yeT4KICA8L3JkZjpEZXNjcmlwdGlvbj4KIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAKPD94cGFja2V0IGVuZD0idyI/PgAdsBEAAAAJcEhZcwAALiMAAC4jAXilP3YAAAAHdElNRQfoDBoTJBupelzWAAAIPElEQVRIx11W224cxxGtruruuc/euCRXJCWKutlE7BiSncSJICRAggTws9/yj/mAIC9BAiMGDCSwYPEiSiKXu+SSe5/ZmdmZ6e48DLliUk/TwKCqzzl9Tjf787ffCCE454iIiAAAAIiIKKslIjLG8LaIaPXn6kNKKR3P94MwDH3f933ftm3b9oUQ3Lbt1YBVd84FkTQGAMxNSyJkDJEYAyRiAACM6GagbdtcOkEQBEHg+b5t25a0iAiJbgYQSURijBERkPA935GWUirOYqSbjYNBRELGkAjAIBIDQCJuYHLZN2htbG56nmdbFrccFJIRoeDc83whOKIkoooKkk5RFKXS+TIPw9AYjUSI1QBc0VIBY2C6x4fN9e0iW2qtbduxbAuFFEIQkRCCu24ghCBLEhEAMACBlILc238xuugO+h82NhsKaNW02gQACCGM1m8PXrtea//zl5eDHqlCSlsKG3hFKjHGeBiGXAiSoloDAJSqLEpV8u2tvWg6Gg6HG51tA1ARWA1gjHHO3578lKfmiy+fkx2EQWBhLIQUQjBOeHsWeBAEQgggRCLGmAEArcZvf+xrce/ZJ27gvf7n98PhtCgKBZxznuWlNhryPAz8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" } }] }] }'
@app.post("/chat")
async def chat_controller(request: Request, chat_id: Annotated[str | None, Header()] = None):
    if chat_id is None:
        chat_id = uuid.uuid4().hex
    
    headers = {
        "Content-Type": "text/html", # "text/plain" can't support streaming in browser, while "text/html" can
        "chat-id": chat_id,
    }
    return StreamingResponse(chat(chat_id, request), headers=headers)


"""
Sample queries:
curl -X POST http://127.0.0.1/chat-llamacpp --header "Content-Type: application/json" --header "chat-id: my-id-123" --data '{ "messages": [{ "role": "user", "content": "where is the headquarter of microsoft" }] }'
curl -X POST http://127.0.0.1/chat-llamacpp --header "Content-Type: application/json" --header "chat-id: my-id-123" --data '{ "messages": [{ "role": "user", "content": "convert the following question to math formula in LaTex format: 2 times x to the power of 2 equals to 8" }] }'
"""
@app.post("/chat-llamacpp")
async def chat_llamacpp_controller(request: Request, chat_id: Annotated[str | None, Header()] = None):
    if chat_id is None:
        chat_id = uuid.uuid4().hex
    
    headers = {
        "Content-Type": "text/html", # "text/plain" can't support streaming in browser, while "text/html" can
        "chat-id": chat_id,
    }
    return StreamingResponse(chat_llamacpp(chat_id, request), headers=headers)


# Sample query:
#   curl -X GET http://127.0.0.1/chat_history --header "Content-Type: application/json" --header "chat-id: test-chat-id"
from fastapi.responses import JSONResponse
@app.get("/chat_history", response_class=JSONResponse)
def chat_history_controller(chat_id: Annotated[str | None, Header()] = None):
    return chat_history(chat_id)
